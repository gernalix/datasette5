{% extends "base.html" %}
{% block content %}
<section class="content">
  <div id="sex-compact">
    <h1>Nuovo record in "sex"</h1>

    {% if message %}
      <p class="message">{{ message }}</p>
    {% endif %}

    <form method="POST">
      <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">

      {# UNA RIGA PER OGNI COLONNA #}
      {% for col in columns %}
        <div class="sex-row">
          <div class="sex-label">
            <label for="search_{{ col.name }}">{{ col.name }}</label>
          </div>
          <div class="sex-input">
            {% if col.is_fk %}
              <div class="fk-field" data-col-name="{{ col.name }}">
                <input
                  type="text"
                  class="fk-search"
                  id="search_{{ col.name }}"
                  placeholder="Filtra {{ col.fk_table }}..."
                >
                <input
                  type="hidden"
                  class="fk-hidden"
                  id="col_{{ col.name }}"
                  name="{{ col.name }}"
                  value=""
                >
                <div class="fk-dropdown">
                  {% for opt in col.options %}
                    <div class="fk-option" data-id="{{ opt.id }}">{{ opt.label }}</div>
                  {% endfor %}
                </div>
              </div>
            {% else %}
              {% if col.name in ["inizio", "fine"] %}
                <input
                  type="datetime-local"
                  id="col_{{ col.name }}_picker"
                  class="dt-picker"
                  data-target="col_{{ col.name }}"
                >
                <input
                  type="hidden"
                  id="col_{{ col.name }}"
                  name="{{ col.name }}"
                  value=""
                >
              {% else %}
                <input
                  type="text"
                  id="col_{{ col.name }}"
                  name="{{ col.name }}"
                  value=""
                >
              {% endif %}
            {% endif %}
          </div>
        </div>
      {% endfor %}

      <div class="sex-actions">
        <button type="submit" class="btn">Salva</button>
        <a href="{{ table_url }}" class="btn">Torna alla tabella sex</a>
      </div>
    </form>
  </div>
</section>

<style>
/* ISOLAMENTO: tutto il form Ã¨ dentro #sex-compact */
#sex-compact {
  padding: 4px 8px !important;
}

/* titolo + messaggi con poco spazio */
#sex-compact h1 {
  margin: 0 0 4px 0 !important;
  font-size: 1.0rem !important;
}
#sex-compact p.message {
  margin: 0 0 4px 0 !important;
  font-size: 0.85rem !important;
}

/* UNA RIGA PER CAMPO, STILE "EXCEL" */
#sex-compact .sex-row {
  display: flex;
  align-items: flex-start;
  margin-bottom: 2px;   /* distanza tra i campi */
  font-size: 0.8rem;
}

/* label stretta, a destra */
#sex-compact .sex-label {
  width: 130px;
  text-align: right;
  padding-right: 6px;
  white-space: nowrap;
}

/* input a destra, che occupa il resto */
#sex-compact .sex-input {
  flex: 1;
}

/* input compatti */
#sex-compact input[type="text"],
#sex-compact input[type="datetime-local"] {
  padding: 1px 2px;
  font-size: 0.8rem;
  max-width: 260px;
  height: 20px;
  box-sizing: border-box;
}

/* gruppi FK: il dropdown deve sovrapporsi */
#sex-compact .fk-field {
  position: relative;
  display: inline-block;
  max-width: 260px;
}

/* dropdown custom che si sovrappone ai campi sottostanti */
#sex-compact .fk-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #ccc;
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
  max-height: 180px;
  overflow-y: auto;
  display: none; /* viene aperto via JS */
  z-index: 9999;
  font-size: 0.8rem;
}

/* singola opzione nel dropdown */
#sex-compact .fk-option {
  padding: 2px 4px;
  cursor: pointer;
  white-space: nowrap;
}
#sex-compact .fk-option:hover {
  background: #eee;
}

/* azzera spazio sotto i pulsanti */
#sex-compact .sex-actions {
  margin-top: 4px;
  font-size: 0.8rem;
}
</style>

<script>
// --- FK: dropdown custom che si sovrappone ai campi ------------------------
(function() {
  function normalize(str) {
    return (str || "").toLowerCase();
  }

  function setupField(field) {
    var search = field.querySelector(".fk-search");
    var hidden = field.querySelector(".fk-hidden");
    var dropdown = field.querySelector(".fk-dropdown");
    if (!search || !hidden || !dropdown) return;

    var options = Array.prototype.slice.call(
      dropdown.querySelectorAll(".fk-option")
    );

    function openDropdown() {
      dropdown.style.display = "block";
    }

    function closeDropdown() {
      dropdown.style.display = "none";
    }

    function filterOptions(query) {
      var q = normalize(query);
      var anyVisible = false;

      options.forEach(function(opt) {
        var text = normalize(opt.textContent || "");
        var match = !q || text.indexOf(q) !== -1;
        opt.style.display = match ? "block" : "none";
        if (match) anyVisible = true;
      });

      // se nessun match, teniamo il menu aperto ma vuoto (o potremmo chiuderlo)
      openDropdown();
    }

    // apertura: focus o click nel campo di ricerca
    search.addEventListener("focus", function() {
      filterOptions(search.value);
    });
    search.addEventListener("click", function() {
      filterOptions(search.value);
    });

    // mentre scrivi, filtriamo e teniamo aperto
    search.addEventListener("input", function() {
      filterOptions(search.value);
    });

    // click su opzione: impostiamo id + label, poi chiudiamo
    options.forEach(function(opt) {
      opt.addEventListener("click", function() {
        hidden.value = opt.getAttribute("data-id");
        search.value = opt.textContent;
        closeDropdown();
      });
    });

    // click fuori dal campo: chiudi il menu
    document.addEventListener("click", function(ev) {
      if (!field.contains(ev.target)) {
        closeDropdown();
      }
    });
  }

  var fields = document.querySelectorAll(".fk-field");
  fields.forEach(setupField);
})();
</script>

<script>
// --- DATETIME-LOCAL -> stringa per SQLite (YYYY-MM-DD HH:MM[:SS]) ----------
(function() {
  function convertDateTimeLocalToSqlite(value) {
    if (!value) return "";
    var parts = value.split("T");
    if (parts.length !== 2) return value;

    var date = parts[0];
    var time = parts[1];

    if (time.length === 5) { // HH:MM
      time = time + ":00";
    }
    return date + " " + time;
  }

  var pickers = document.querySelectorAll(".dt-picker");
  pickers.forEach(function(picker) {
    var targetId = picker.getAttribute("data-target");
    if (!targetId) return;
    var hidden = document.getElementById(targetId);
    if (!hidden) return;

    picker.addEventListener("change", function() {
      hidden.value = convertDateTimeLocalToSqlite(picker.value);
    });
  });
})();
</script>
{% endblock %}
