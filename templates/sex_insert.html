{% extends "base.html" %}
{% block content %}
<section class="content">
  <div id="sex-compact">
    <h1>Nuovo record in "sex"</h1>

    {% if message %}
      <p class="message">{{ message }}</p>
    {% endif %}

    <form method="POST">
      <input type="hidden" name="csrftoken" value="{{ csrftoken() }}">

      {# UNA RIGA PER OGNI COLONNA #}
      {% for col in columns %}
        <div class="sex-row">
          <div class="sex-label">
            <label for="col_{{ col.name }}">{{ col.name }}</label>
          </div>
          <div class="sex-input">
            {% if col.is_fk %}
              <div class="fk-field">
                <input
                  type="text"
                  class="fk-search"
                  placeholder="Filtra {{ col.fk_table }}..."
                  data-target="col_{{ col.name }}"
                >
                <select id="col_{{ col.name }}" name="{{ col.name }}">
                  <option value="">-- seleziona {{ col.fk_table }} --</option>
                  {% for opt in col.options %}
                    <option value="{{ opt.id }}">{{ opt.label }}</option>
                  {% endfor %}
                </select>
              </div>
            {% else %}
              {% if col.name in ["inizio", "fine"] %}
                <input
                  type="datetime-local"
                  id="col_{{ col.name }}_picker"
                  class="dt-picker"
                  data-target="col_{{ col.name }}"
                >
                <input
                  type="hidden"
                  id="col_{{ col.name }}"
                  name="{{ col.name }}"
                  value=""
                >
              {% else %}
                <input
                  type="text"
                  id="col_{{ col.name }}"
                  name="{{ col.name }}"
                  value=""
                >
              {% endif %}
            {% endif %}
          </div>
        </div>
      {% endfor %}

      <div class="sex-actions">
        <button type="submit" class="btn">Salva</button>
        <a href="{{ table_url }}" class="btn">Torna alla tabella sex</a>
      </div>
    </form>
  </div>
</section>

<style>
/* ISOLAMENTO: tutto il form è dentro #sex-compact */
#sex-compact {
  padding: 4px 8px !important;
}

/* titolo + messaggi con poco spazio */
#sex-compact h1 {
  margin: 0 0 4px 0 !important;
  font-size: 1.0rem !important;
}
#sex-compact p.message {
  margin: 0 0 4px 0 !important;
  font-size: 0.85rem !important;
}

/* UNA RIGA PER CAMPO, STILE "EXCEL" */
#sex-compact .sex-row {
  display: flex;
  align-items: center;
  margin-bottom: 2px;   /* <-- distanza tra i campi */
  font-size: 0.8rem;
}

/* label stretta, a destra */
#sex-compact .sex-label {
  width: 130px;
  text-align: right;
  padding-right: 6px;
  white-space: nowrap;
}

/* input a destra, che occupa il resto */
#sex-compact .sex-input {
  flex: 1;
}

/* input e select compatti */
#sex-compact input[type="text"],
#sex-compact input[type="datetime-local"],
#sex-compact select {
  padding: 1px 2px;
  font-size: 0.8rem;
  max-width: 260px;
  height: 20px;
  box-sizing: border-box;
}

/* quando il select si apre (size>1), limitiamo solo l’altezza massima */
#sex-compact select[size] {
  max-height: 130px;
}

/* gruppi FK in colonna, poco spazio */
#sex-compact .fk-field {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

/* azzera spazio sotto i pulsanti */
#sex-compact .sex-actions {
  margin-top: 4px;
  font-size: 0.8rem;
}
</style>

<script>
// --- FK: filtro + lista "aperta" mentre scrivi ------------------------------
(function() {
  function normalize(str) {
    return (str || "").toLowerCase();
  }

  function countVisibleOptions(selectEl) {
    var count = 0;
    var opts = selectEl.options;
    for (var i = 0; i < opts.length; i++) {
      if (!opts[i].hidden) count++;
    }
    return count;
  }

  function expandSelect(selectEl) {
    var visible = countVisibleOptions(selectEl);
    var total = selectEl.options.length;
    var size = visible || total || 2;
    if (size > 10) size = 10;
    if (size < 2) size = 2;
    selectEl.size = size;
    selectEl.dataset.expanded = "1";
    selectEl.style.maxHeight = "130px";
  }

  function filterSelect(selectEl, query) {
    var q = normalize(query);
    var opts = selectEl.options;

    for (var i = 0; i < opts.length; i++) {
      var opt = opts[i];

      if (!opt.value) {
        opt.hidden = false;
        continue;
      }

      var text = normalize(opt.textContent || opt.innerText || "");
      opt.hidden = text.indexOf(q) === -1;
    }

    if (selectEl.dataset.expanded === "1") {
      expandSelect(selectEl);
    }
  }

  var inputs = document.querySelectorAll(".fk-search");
  inputs.forEach(function(input) {
    var targetId = input.getAttribute("data-target");
    if (!targetId) return;
    var selectEl = document.getElementById(targetId);
    if (!selectEl) return;

    // quando entri nel campo di ricerca, apri la lista
    input.addEventListener("focus", function() {
      expandSelect(selectEl);
    });

    // mentre scrivi, filtra mantenendo aperto
    input.addEventListener("input", function() {
      filterSelect(selectEl, input.value);
    });
  });
})();
</script>

<script>
// --- DATETIME-LOCAL -> stringa per SQLite (YYYY-MM-DD HH:MM[:SS]) ----------
(function() {
  function convertDateTimeLocalToSqlite(value) {
    if (!value) return "";
    var parts = value.split("T");
    if (parts.length !== 2) return value;

    var date = parts[0];
    var time = parts[1];

    if (time.length === 5) { // HH:MM
      time = time + ":00";
    }
    return date + " " + time;
  }

  var pickers = document.querySelectorAll(".dt-picker");
  pickers.forEach(function(picker) {
    var targetId = picker.getAttribute("data-target");
    if (!targetId) return;
    var hidden = document.getElementById(targetId);
    if (!hidden) return;

    picker.addEventListener("change", function() {
      hidden.value = convertDateTimeLocalToSqlite(picker.value);
    });
  });
})();
</script>
{% endblock %}
